\documentclass{scrartcl}

\usepackage{multirow}

\usepackage{listings}
\lstset{basicstyle=\footnotesize\ttfamily}

\usepackage{tikz}
\usepackage{pgf-umlsd}

\usepgflibrary{arrows} % for pgf-umlsd

\title{MUSTE server protocol}
\author{Herbert Lange}
\date{Document version 0.0.1}
\begin{document}
\maketitle

\section{Design principles}

\begin{itemize}
\item stateful - authentication happens once
\item unidirectional - client sends request, server answers
\end{itemize}

\section{Message format}

\begin{itemize}
\item Client messages (CM) are messages from the client sent to the server

  \begin{tabular}{llp{0.6\textwidth}}
    Message Name                      & Valid Responses   & Description \\
    \hline
    \multirow{2}{*}{CMLoginRequest}   & SMLoginSuccess & \multirow{2}{*}{Send login request} \\
                                      & SMLoginFail \\
    \hline
    \multirow{2}{*}{CMMOTDRequest}    & SMMOTDResponse    & \multirow{2}{0.6\textwidth}{Request a Message-of-the-day, e.g. the user survey from the server} \\
                                      & SMSessionInvalid \\
    \hline
    \multirow{3}{*}{CMDataResponse}   & SMDataReceived    & \multirow{3}{*}{Send result of the survey} \\
                                      & SMDataInvalid \\
                                      & SMSessionInvalid \\
    \hline
    \multirow{2}{*}{CMLessonsRequest} & SMLessonsList     & \multirow{2}{*}{Request available lessons} \\
                                      & SMSessionInvalid \\
    \hline
    \multirow{3}{*}{CMLessonInit}     & SMMenuList     & \multirow{3}{*}{Start a new lesson} \\
                                      & SMLessonInvalid \\
                                      & SMSessionInvalid \\
    \hline
    \multirow{3}{*}{CMMenuRequest}    & SMMenuList        & \multirow{3}{*}{Send request for menus} \\
                                      & SMLessonInvalid \\
                                      & SMSessionInvalid \\
    \hline
    CMLogoutRequest                   & SMLogoutResponse & Ends a session \\
    \hline
\end{tabular}

\item Server messages (SM) are messages from the servert sent to a client

  \begin{tabular}{ll}
    Message Name      & Description \\
    \hline
    SMLoginSuccess & Login successful \\
    SMLoginFail     & Login failed \\
    SMMOTDResponse    & A potential html-fragment for a message of the day \\
    SMSessionInvalid  & Invalid Session \\
    SMDataReceived    & Data received \\
    SMDataInvalid     & Invalid data \\
    SMLessonsList     & Lesson listing \\
%    SMLessonStart     & Initial data for a lesson \\
    SMLessonInvalid   & Invalid lesson \\
    SMMenuList        & List of possible menus in a lesson \\
  \end{tabular}

\end{itemize}

\section{Message Datatypes}

General format:
\begin{lstlisting}
  {"message":string, "parameters":object}
\end{lstlisting}
With \texttt{message} field containing the message name and \texttt{parameters} containing (optional) message parameters.

\begin{tabular}{lll}
  Message & Parameters \\
  \hline
  CMLoginRequest &
  \begin{lstlisting}
    {"username":string,"password":string}
  \end{lstlisting} \\
  \hline
  CMMOTDRequest &
  \begin{lstlisting}
    {"token":string}
  \end{lstlisting} \\
  \hline
  CMDataResponse &
  \begin{lstlisting}
    {"token":string,"context":string,
     "data":["field":string,"value":string]}
  \end{lstlisting} & {\bfseries\footnotesize 1} \\
  \hline
  CMLessonsRequest &
  \begin{lstlisting}
    {"token":string}
  \end{lstlisting} \\
  \hline
  CMLessonInit &
  \begin{lstlisting}
    {"token":string,"lesson":string}
  \end{lstlisting} \\
  \hline
  CMMenuRequest &
  \begin{lstlisting}
    {"token":string,"score":number,
      "a":{"tree":string,"grammar":string},
      "b":{"tree":string,"grammar":string}
    }
  \end{lstlisting} \\
  \hline
  CMLogoutRequest &
  \begin{lstlisting}
    {"token":string}
  \end{lstlisting} \\
  \hline
  SMLoginSuccessful &
  \begin{lstlisting}
    {"token":string}
  \end{lstlisting} & {\bfseries\footnotesize 2} \\
  \hline
  SMLoginFail &
  \begin{lstlisting}
    null
  \end{lstlisting} \\
  \hline
  SMMOTDResponse &
  \begin{lstlisting}
    {"filename":string}
  \end{lstlisting} & {\bfseries\footnotesize 3} \\
  \hline
  SMSessionInvalid &
  \begin{lstlisting}
    {"error":string}
  \end{lstlisting} & {\bfseries\footnotesize 4} \\
  \hline
  SMLessonsList &
  \begin{lstlisting}
    {"lessons":[{"name":string,"passed":boolean,
                 "exercisecount":number}]}
  \end{lstlisting} & {\bfseries\footnotesize 5} \\
  \hline
  %% SMLessonStart &
  %% \begin{lstlisting}
  %%   {"passed":bool,"score":number,
  %%     "a":{"lesson":string,"tree":string,"lin":[{"path":[number],"lin":string}],
  %%       "menu":{:[[{"score":number, "lin":[[[number],string]]}]]}},
  %%     "b":{"lesson":string,"tree":string,"lin":[{"path":[number],"lin":string}],
  %%       "menu":{:[[{"score":number, "lin":[[[number],string]]}]]}},}:
  %% \end{lstlisting} \\
  SMMenuList &
  \begin{lstlisting}
    {"passed":bool,"score":number,
      "a":{"lesson":string,"tree":string,
           "lin":[{"path":[number],"lin":string}],
           "menu":{:[[{"score":number,
                       "lin":[[[number],string]]}]]}},
      "b":{"lesson":string,"tree":string,
           "lin":[{"path":[number],"lin":string}],
           "menu":{:[[{"score":number,
                       "lin":[[[number],string]]}]]}}}:
  \end{lstlisting} & {\bfseries\footnotesize 5} \\
  \hline
  SMLessonInvalid &
  \begin{lstlisting}
    null
  \end{lstlisting} \\
  \hline
  SMDataReceived &
  \begin{lstlisting}
    null
  \end{lstlisting} \\
  \hline
  SMDataInvalid &
  \begin{lstlisting}
    {"error":string}
  \end{lstlisting} & {\bfseries\footnotesize 6} \\
  \hline
  SMLogoutResponse &
  \begin{lstlisting}
    null
  \end{lstlisting} \\
  \hline
\end{tabular}

\begin{description}
\item[{\footnotesize 1}] \texttt{token} is an identifier assigned to the client session by the server. \texttt{context} defines the semantics of \texttt{data}.

  \begin{itemize}
  \item For \emph{startQuestionaire} and \emph{finalQuestionaire}: \texttt{field} can be one of \emph{Field1} to \emph{Field20} and \texttt{value} can either be a number between 1 and 5 for fields with Likert scale and a string for the freeform fields
  \item For \emph{finishedSession} and \emph{canceledSession}: \texttt{field} is \emph{PlayTime} and \texttt{value} is the time used for completing the session or before canceling and going back
  \end{itemize}
\item[{\footnotesize 2}] The token to be used by all following client requests
\item[{\footnotesize 3}] A file name to be displayed as a message of the day
\item[{\footnotesize 4}] Reason like timeout or not authenticated
\item[{\footnotesize 5}] lessen \emph{name} and \emph{lesson} are the same as the name of the PGF used for the lesson
\item[{\footnotesize 6}] Potential error message
\end{description}
%% [{ name : string, passed : bool }]
\section{Sequences}

\begin{sequencediagram}
  \newthread{server}{Ajax-Server}{Server}
  \newthread[5]{client}{Web-Client}{Client}
  \begin{call}{client}{CMLoginRequest}{server}{SMLoginSuccess}
  \end{call}
  
  \begin{call}{client}{CMMOTDRequest}{server}{SMMOTDResponse}
  \end{call}
  
  
  \begin{call}{client}{CMDataResponse}{server}{SMDataReceived}
  \end{call}

  \begin{call}{client}{CMLessonsRequest}{server}{SMLessonsList}
  \end{call}
  
  \begin{call}{client}{CMClientInit}{server}{SMMenuList}
  \end{call}

  \begin{sdblock}{Lesson Loop}{}
    %\begin { call }{ ps }{ PhysicsUpdate () }{ ps }{}
    %\end { call }
    \begin{call}{client}{CMMenuRequest}{server}{SMMenuList}
    \end{call}
  \end{sdblock}
  \begin{call}{client}{CMDataResponse}{server}{SMDataReceived}
  \end{call}
\end{sequencediagram}

\section{Database}
\end{document}
